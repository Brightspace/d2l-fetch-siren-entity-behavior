<link rel="import" href="../polymer/polymer.html">

<script src="https://s.brightspace.com/lib/siren-parser/6.0.0/siren-parser.js"></script>
<script src="https://s.brightspace.com/lib/d2lfetch/1.2.0/d2lfetch.js"></script>
<script>
	'use strict';

	/* @polymerBehavior fetchSirenEntityBehaviorImpl */
	var fetchSirenEntityBehaviorImpl = {

		properties: {
			_timeSkew: Number
		},

		_fetchEntity: function(url) {
			var request = new Request(url, {
				headers: new Headers({ Accept: 'application/vnd.siren+json' })
			});
			return this._makeRequest(request);
		},

		_fetchEntityWithToken: function(url, getToken, userUrl) {
			var tokenUrl = userUrl || url;
			if (url && typeof getToken === 'function' && tokenUrl) {
				return getToken(tokenUrl)
					.then(function(token) {
						if (typeof token === 'string') {
							var request = new Request(url, {
								headers: new Headers({
									Accept: 'application/vnd.siren+json',
									Authorization: 'Bearer ' + token
								})
							});
							return this._makeRequest(request);
						} else {
							throw new Error('token expected to be a string');
						}
					}.bind(this));
			}
		},

		_makeRequest: function(request) {
			var self = this;
			return window.d2lfetch
				.fetch(request)
				.then(function(response) {
					if (response.ok) {
						var serverTimeUtc = new Date(response.headers.get('Date'));
						self._timeSkew = Math.round(serverTimeUtc / 1000) - Math.round(new Date() / 1000);
						return response.json();
					}
					return Promise.reject(response.status);
				})
				.then(window.D2L.Hypermedia.Siren.Parse);
		}
	};

	window.D2L = window.D2L || {};
	/*
	* Behavior for basic siren entity fetching which parses output on return.
	* @polymerBehavior window.D2L.FetchSirenEntityBehavior
	*/
	window.D2L.FetchSirenEntityBehavior = [
		fetchSirenEntityBehaviorImpl
	];
</script>
